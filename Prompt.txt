## TASK: API Migration Regression Test – Compatibility Layer Implementation

### Context

You are implementing a **backward-compatibility layer** to support API evolution across **v1 → v2 → v3**.
Legacy consumers depend on the v1 contract and **cannot be modified**.
Newer APIs introduce **breaking structural and semantic changes**.

Your responsibility is to:

* Implement transformation logic from v2/v3 → v1
* Design and execute regression tests that prove correctness and safety

---

### API Schema Evolution

#### v1 (Legacy)

```json
{
  "orderId": "...",
  "status": "PAID | CANCELLED | SHIPPED",
  "totalPrice": 123.45,
  "customerId": "...",
  "customerName": "...",
  "createdAt": "YYYY-MM-DD",
  "items": []
}
```

* Flat schema
* USD only
* Naive date format

---

#### v2 (Current)

```json
{
  "orderId": "...",
  "state": "PAID | CANCELLED | SHIPPED | FULFILLED",
  "amount": { "value": 123.45, "currency": "USD" },
  "customer": { "id": "...", "name": "..." },
  "createdAt": "ISO-8601",
  "lineItems": []
}
```

* Nested structures
* Multi-currency
* Extended status enum

---

#### v3 (New)

```json
{
  "data": [
    {
      "orderId": "...",
      "orderStatus": { "current": "...", "history": [] },
      "pricing": { "subtotal": 0, "tax": 0, "discount": 0, "total": 0 },
      "customer": { ... },
      "timestamps": { "created": "...", "fulfilled": "..." }
    }
  ]
}
```

* Pagination wrapper
* Deep nesting
* Derived pricing fields
* Status history

---

### Functional Requirements

1. **Version Auto-Detection**

   * v3 responses contain a top-level `data[]`
   * v2 responses contain `orderId` at the root
   * No reliance on URLs or headers

2. **Context-Aware Status Mapping**

   * `FULFILLED` + trackingNumber → `SHIPPED` (physical)
   * `FULFILLED` without tracking → `SHIPPED` (digital)
   * Output must conform to v1 enum set

3. **Price Validation**

   * Detect inconsistencies between stated totals and line item calculations
   * Recalculate total when needed
   * Emit non-fatal warnings

4. **Currency Normalization**

   * Convert all prices to USD before emitting v1 output

5. **Date Normalization**

   * ISO-8601 → `YYYY-MM-DD`
   * Timezone-safe conversion

6. **Audit Trail**

   * Record mapping decisions and warnings
   * Do not break legacy response schema

---

### Your Tasks

#### 1. Test Design

Create test scenarios that cover:

* v2 price mismatch (amount ≠ sum of lineItems)
* v3 context-dependent status mapping
* Currency conversion edge cases
* Timezone normalization
* Error and warning handling
* Any additional edge cases you identify

#### 2. Test Data

* Define test cases in a `CASES` structure **or**
* Mock API responses inside `request_json()`

#### 3. Implementation

Implement the following functions:

* `request_json()` – return mocked v2/v3 responses
* `detect_version()` – determine source API version
* `to_legacy()` – convert v2/v3 responses to v1 format
* `run_tests()` – execute and validate all test cases
* Additional helpers as needed

---

### Success Criteria

* Running:

```bash
python e2e_api_regression_harness.py
```

results in:

* All tests passing
* No schema violations
* Correct handling of edge cases
* Clear, auditable transformation logic

---

### Evaluation Focus

This task evaluates your ability to:

* Manage breaking API evolution
* Preserve backward compatibility
* Design meaningful regression tests
* Implement defensive, production-grade transformation logic
